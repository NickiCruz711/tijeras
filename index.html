<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formato G Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX/TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
</head>
<body class="bg-black">
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        // --- TYPES ---
        interface Track {
          id: number;
          title: string;
          artist: string;
          duration: string;
          albumArt: string;
          available: boolean;
          audioSrc: string;
          featuring?: string;
        }

        interface Album {
          id: number;
          title: string;
          artists: string[];
          releaseYear: string;
          imageUrl: string;
          bio: string;
          tracks: Track[];
          buyUrl?: string;
        }

        // --- CONSTANTS ---
        const ALBUMS_DATA: Album[] = [
          {
            id: 1,
            title: 'Sylvina Brizuela',
            artists: ['Sylvina Brizuela'],
            releaseYear: '2012-∞',
            imageUrl: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg',
            bio: 'Sylvina Brizuela es cantante solista de folklore y profesora de vocalización de la ciudad de Presidencia Roque Sáenz Peña en la provincia del Chaco. Con una voz profunda y auténtica, combina la fuerza del canto tradicional con una calidez cercana que conecta con su público.',
            buyUrl: 'https://tiendaguah.com/sylvina-brizuela',
            tracks: [
              { id: 1, title: 'Aunque yo me muera', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: true, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/Aunque%20yo%20me%20muera.mp3' },
              { id: 2, title: 'Bailar de esa manera', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: true, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/Bailar%20de%20esa%20manera.mp3' },
              { id: 3, title: 'Cómo ristra é chacarera', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: true, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/C%C3%B3mo%20ristra%20%C3%A9%20chacarera.mp3' },
              { id: 4, title: 'Gatito enamorado', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: false, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/Gatito%20enamorado.mp3' },
              { id: 5, title: 'La difícil', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: false, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/La%20dif%C3%ADcil.mp3' },
              { id: 6, title: 'La rogadita', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: false, featuring: 'Federico Díaz', audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/La%20gordita%20con%20Feder%C3%ADco%20D%C3%ADaz.mp3' },
              { id: 7, title: 'Me quedo', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: false, audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/Me%20quedo.mp3' },
              { id: 8, title: 'Sos lo que yo quiero', artist: 'Sylvina Brizuela', duration: '0:00', albumArt: 'https://ia600401.us.archive.org/10/items/tapa_20250702/tapa.jpg', available: false, featuring: 'Federico Díaz', audioSrc: 'https://archive.org/download/como-ristra-e-chacarera/Sos%20lo%20que%20yo%20quiero%20con%20Federico%20D%C3%ADaz.mp3' },
            ]
          },
          {
            id: 2,
            title: 'Des Muda',
            artists: ['Nohemí'],
            releaseYear: '2024',
            imageUrl: 'https://dn721503.ca.archive.org/0/items/003_20250622_202506/004.jpg',
            bio: 'Des Muda es el álbum debut de Nohemí, una colección de canciones que exploran la vulnerabilidad y la fuerza a través de melodías pop-rock con letras introspectivas.',
            buyUrl: 'https://tiendaguah.com/nohemi/des-muda',
            tracks: [
              { id: 9, title: 'Boleto de salida', artist: 'Nohemí', duration: '0:00', albumArt: 'https://dn721502.ca.archive.org/0/items/luis_20250625/004.jpg', available: true, audioSrc: 'https://archive.org/download/desmuda_202506/01%20-%20Boleto%20de%20salida.mp3' },
              { id: 10, title: 'Sin miedo a decirte', artist: 'Nohemí', duration: '0:00', albumArt: 'https://dn721502.ca.archive.org/0/items/luis_20250625/004.jpg', available: true, audioSrc: 'https://archive.org/download/desmuda_202506/02%20-%20Sin%20miedo%20a%20decirte.mp3' },
              { id: 11, title: 'La sombra de un cuento', artist: 'Nohemí', duration: '0:00', albumArt: 'https://dn721502.ca.archive.org/0/items/luis_20250625/004.jpg', available: false, audioSrc: 'https://archive.org/download/desmuda_202506/05%20-%20La%20sombra%20de%20un%20cuento.mp3' },
            ],
          },
          {
            id: 3,
            title: 'Hijo del Rey',
            artists: ['Josué Medina'],
            releaseYear: '2023',
            imageUrl: 'https://ia601309.us.archive.org/17/items/folder_20250626_0504/folder.jpg',
            bio: 'Un álbum de adoración y alabanza contemporánea que refleja una profunda fe y devoción. Josué Medina combina guitarras acústicas con arreglos modernos para crear una experiencia espiritual.',
            buyUrl: 'https://tiendaguah.com/josue-medina/hijo-del-rey',
            tracks: [
              { id: 12, title: 'Tu Hijo Soy', artist: 'Josué Medina', duration: '0:00', albumArt: 'https://ia601309.us.archive.org/17/items/folder_20250626_0504/folder.jpg', available: true, audioSrc: 'https://archive.org/download/05-quien-dijo-que-no/01%20-%20Tu%20Hijo%20Soy.mp3' },
              { id: 13, title: 'Yo No Se', artist: 'Josué Medina', duration: '0:00', albumArt: 'https://ia601309.us.archive.org/17/items/folder_20250626_0504/folder.jpg', available: true, audioSrc: 'https://archive.org/download/05-quien-dijo-que-no/02%20-%20Yo%20No%20Se.mp3' },
              { id: 14, title: 'Promesas', artist: 'Josué Medina', duration: '0:00', albumArt: 'https://ia601309.us.archive.org/17/items/folder_20250626_0504/folder.jpg', available: false, audioSrc: 'https://archive.org/download/05-quien-dijo-que-no/03%20-%20Promesas.mp3' },
            ],
          },
        ];

        // --- COMPONENTS ---

        const Icon = ({ name, className = 'w-6 h-6' }) => {
          const icons = {
            play: <path d="M6 4l12 8-12 8V4z" />,
            pause: <path d="M6 4h4v16H6zM14 4h4v16h-4z" />,
            next: <path d="M6 18l8.5-6L6 6v12zM18 6v12h-2V6h2z" />,
            previous: <path d="M18 6l-8.5 6L18 18V6zM6 6v12h2V6H6z" />,
            stop: <path d="M6 6h12v12H6z" />,
            volume: <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />,
            eye: <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8zm11 0a3 3 0 100-6 3 3 0 000 6z" />,
            download: <path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14a6 6 0 006 6h13a5 5 0 005-5c0-2.48-1.79-4.52-4.15-4.96zM17 13v4h-2v-4h-3l4-4 4 4h-3z"/>,
            check: <path fillRule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.46-12.69a.75.75 0 011.04-.208z" clipRule="evenodd" />,
            loading: <path d="M12 4V2A10 10 0 002 12h2a8 8 0 018-8z" />,
            back: <path fillRule="evenodd" d="M7.72 12.53a.75.75 0 010-1.06l7.5-7.5a.75.75 0 111.06 1.06L9.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5z" clipRule="evenodd" />
          };
          return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true">{icons[name] || <path d="M0 0h24v24H0z" fill="none" />}</svg>;
        };
        
        const Header = () => (
            <header className="bg-gradient-to-b from-neutral-800 to-[#121212] p-4 sm:p-6 md:p-8">
              <div className="flex items-center justify-center mb-8">
                  <img src="https://ia600700.us.archive.org/10/items/logo-horizontal-blanco-07/logo%20horizontal%20blanco-07.png" alt="Formato G Logo" className="h-10" />
              </div>
              <div className="relative h-32 sm:h-40 md:h-48 rounded-lg overflow-hidden bg-neutral-900">
                  <img src="https://images.pexels.com/photos/3642351/pexels-photo-3642351.jpeg" alt="A concert with a large crowd and stage lights" className="absolute inset-0 w-full h-full object-cover" />
                  <div className="absolute inset-0 bg-black/50" />
                  <div className="relative z-10 h-full flex items-center justify-center p-4">
                      <img src="https://archive.org/download/lema-01/lema-01.png" alt="Lema: La música vuelve a ser tuya" className="w-auto h-16 sm:h-20 md:h-24" />
                  </div>
              </div>
            </header>
        );

        const AlbumCard = ({ album, onSelectAlbum, onBuyAlbum }) => {
            const artistsString = album.artists.join(', ');
            return (
              <div className="group relative flex flex-col cursor-pointer" onClick={() => onSelectAlbum(album.id)}>
                <div className="relative w-full aspect-square mb-2">
                  <img src={album.imageUrl} alt={album.title} className="w-full h-full object-cover rounded-md shadow-lg" />
                  <div className="absolute inset-0 bg-black/20 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" />
                  {album.buyUrl && (
                    <button onClick={(e) => { e.stopPropagation(); onBuyAlbum(album); }} className="hidden md:block absolute top-2 right-2 bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-red-500 backdrop-blur-sm opacity-0 group-hover:opacity-100 transform group-hover:translate-y-0 -translate-y-4 transition-all duration-200 ease-in-out hover:scale-110" aria-label={`Comprar ${album.title}`}>
                      Comprar
                    </button>
                  )}
                  <button onClick={(e) => { e.stopPropagation(); onSelectAlbum(album.id, true); }} className="absolute bottom-3 right-3 w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center shadow-2xl opacity-0 group-hover:opacity-100 transform group-hover:translate-y-0 translate-y-6 transition-all duration-300 ease-in-out hover:scale-110" aria-label={`Play ${album.title}`}>
                    <Icon name="play" className="w-6 h-6 ml-1" />
                  </button>
                </div>
                <div className="text-left">
                  <h3 className="font-semibold text-white truncate text-base">{album.title}</h3>
                  <p className="text-sm text-gray-400 truncate">{artistsString}</p>
                </div>
              </div>
            );
        };
        
        const AlbumBrowser = ({ onSelectAlbum, onBuyAlbum }) => (
            <main className="p-4 sm:p-6 md:p-8">
              <section className="mb-8 md:mb-12 text-center max-w-4xl mx-auto">
                <h1 className="text-3xl md:text-4xl font-bold mb-4 text-white">¿De qué se trata Formato G?</h1>
                <div className="space-y-4 text-neutral-300 text-base md:text-lg leading-relaxed">
                  <p>Formato G es una herramienta para artistas y bandas independientes que quieren tener el control total de su obra. Subí tus canciones y compartilo con quien quieras. Sin comisiones. Sin algoritmos. Sin intermediarios. Solo vos, tu música… y tu gente.</p>
                  <p className="italic">Formato G. La música Vuelve a ser <span className="text-red-500 font-bold">tuya</span>.</p>
                </div>
              </section>
              <h2 className="text-2xl font-bold mb-6 text-white">Artistas y Bandas</h2>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                {ALBUMS_DATA.map((album) => (
                  <AlbumCard key={album.id} album={album} onSelectAlbum={onSelectAlbum} onBuyAlbum={onBuyAlbum} />
                ))}
              </div>
            </main>
        );

        const PurchaseModal = ({ isOpen, onClose, album, onUnlock }) => {
            if (!isOpen || !album) return null;
            
            const [code, setCode] = React.useState('');
            const modalRef = React.useRef(null);

            React.useEffect(() => {
                if (code === '123456') onUnlock(album.id);
            }, [code, onUnlock, album.id]);

            const handleBackdropClick = (e) => {
                if (modalRef.current && !modalRef.current.contains(e.target)) onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={handleBackdropClick}>
                    <div ref={modalRef} className="bg-zinc-900 border border-zinc-700/50 text-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center relative">
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors text-2xl" aria-label="Cerrar modal">&times;</button>
                        <h2 className="text-2xl font-bold mb-2">Estas por comprar el Álbum</h2>
                        <p className="text-xl font-semibold text-green-400 mb-4">{album.title}</p>
                        <p className="text-sm text-gray-400 mb-6">de {album.artists.join(', ')}</p>
                        <a href={album.buyUrl} target="_blank" rel="noopener noreferrer" className="block w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-500 transition-colors duration-200 mb-8">Pagar</a>
                        <div className="border-t border-zinc-700/50 my-6"></div>
                        <label htmlFor="purchase-code" className="block text-sm text-gray-400 mb-2">Insertar Código de compra</label>
                        <input id="purchase-code" type="text" maxLength="6" value={code} onChange={(e) => setCode(e.target.value.replace(/[^0-9]/g, ''))} className="bg-zinc-700 text-center text-2xl font-mono tracking-[0.5em] p-3 rounded-lg w-full max-w-xs mx-auto focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="------" autoFocus/>
                    </div>
                </div>
            );
        };

        const TrackItem = ({ track, index, isCurrent, isPlaying, onTrackSelect, isAlbumUnlocked, downloadedTracks, downloading, onDownload }) => {
            const isAvailable = track.available || isAlbumUnlocked;
            const isDownloaded = downloadedTracks.has(track.id);
            const isDownloading = downloading.has(track.id);

            return (
                <li className={`flex items-center gap-4 p-2 rounded-md transition-colors duration-200 ${isCurrent ? "bg-zinc-700" : ""} ${isAvailable ? "hover:bg-zinc-800 cursor-pointer" : "opacity-50"}`} onClick={() => isAvailable && onTrackSelect(track)}>
                    <div className="w-6 text-right text-gray-400 flex items-center justify-center">
                        {isCurrent && isPlaying ? <Icon name="volume" className="w-4 h-4 text-green-400 animate-pulse" /> : <span className={isCurrent ? "text-green-400" : "text-white"}>{index + 1}</span>}
                    </div>
                    <img src={track.albumArt} alt={track.title} className="w-10 h-10 rounded-sm" />
                    <div className="flex-1 min-w-0">
                        <p className={`${isCurrent ? "text-green-400" : "text-white"} truncate`}>{track.title}</p>
                        {track.featuring && <p className="text-xs text-gray-400">(con {track.featuring})</p>}
                    </div>
                    <div className="flex items-center gap-2 ml-2">
                        {isAvailable ? (
                            <button onClick={(e) => { e.stopPropagation(); onDownload(track); }} disabled={isDownloaded || isDownloading} className="p-2 rounded-full hover:bg-zinc-600 disabled:opacity-50 disabled:cursor-not-allowed" aria-label={isDownloaded ? 'Descargado' : (isDownloading ? 'Descargando' : 'Descargar')}>
                                {isDownloading ? <Icon name="loading" className="w-5 h-5 text-blue-400 animate-spin" /> : isDownloaded ? <Icon name="check" className="w-5 h-5 text-green-400" /> : <Icon name="download" className="w-5 h-5 text-gray-400" />}
                            </button>
                        ) : (
                             <Icon name="eye" className="w-5 h-5 text-gray-500" />
                        )}
                    </div>
                </li>
            );
        };

        const TrackList = ({ tracks, ...props }) => (
            <ul className="space-y-1">
                {tracks.map((track, index) => <TrackItem key={track.id} track={track} index={index} {...props} />)}
            </ul>
        );

        const AlbumView = ({ album, onBack, onBuyAlbum, ...props }) => {
            const { unlockedAlbums, downloadedTracks, showOnlyDownloaded, setShowOnlyDownloaded } = props;
            const isAlbumUnlocked = unlockedAlbums.has(album.id);
            const tracksToShow = showOnlyDownloaded ? album.tracks.filter(t => downloadedTracks.has(t.id)) : album.tracks;

            return (
                <div className="flex flex-col lg:flex-row gap-8 p-4 lg:p-8 flex-1 overflow-hidden">
                    <aside className="w-full lg:w-1/3 lg:max-w-sm flex-shrink-0 lg:overflow-y-auto thin-scrollbar">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-400 hover:text-white mb-4 transition-colors">
                           <Icon name="back" className="w-5 h-5" /> Volver a Álbumes
                        </button>
                        <img src={album.imageUrl} alt={album.title} className="w-full h-auto object-cover aspect-square mb-4 shadow-lg rounded-md"/>
                        <h2 className="text-3xl font-bold text-white">{album.title}</h2>
                        <p className="text-lg text-gray-300 mb-4">{album.artists.join(', ')} - {album.releaseYear}</p>
                        {!isAlbumUnlocked && <button onClick={() => onBuyAlbum(album)} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-500 transition-colors duration-200 mb-4">Comprar Álbum</button>}
                        <p className="text-sm text-gray-400 leading-relaxed">{album.bio}</p>
                    </aside>
                    <div className="flex-1 flex flex-col min-h-0 bg-zinc-900 rounded-lg p-4">
                      <div className="flex justify-end items-center mb-4 sticky top-0 bg-zinc-900/80 backdrop-blur-sm py-2 z-10">
                          <label htmlFor="offline-toggle" className="mr-3 text-sm font-medium text-gray-300">Mostrar solo descargadas</label>
                          <div className="relative inline-block w-10 align-middle select-none">
                              <input type="checkbox" id="offline-toggle" checked={showOnlyDownloaded} onChange={() => setShowOnlyDownloaded(!showOnlyDownloaded)} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                              <label htmlFor="offline-toggle" className="toggle-label block overflow-hidden h-6 rounded-full bg-zinc-600 cursor-pointer"></label>
                          </div>
                      </div>
                      <div className="flex-1 overflow-y-auto thin-scrollbar">
                        {tracksToShow.length > 0 ? (
                           <TrackList tracks={tracksToShow} isAlbumUnlocked={isAlbumUnlocked} {...props} />
                        ) : (
                          <div className="text-center text-gray-500 py-8 px-4">
                                <p className="font-semibold">No has descargado ninguna canción de este álbum.</p>
                                <p className="text-sm">Usa el ícono de descarga para guardar canciones.</p>
                          </div>
                        )}
                      </div>
                    </div>
                </div>
            );
        };

        const formatTime = (time) => {
            if (isNaN(time) || time === 0) return '0:00';
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        };

        const Player = ({ currentTrack, isPlaying, onPlayPause, onNext, onPrev, progress, onSeek, volume, onVolumeChange, onStop }) => {
            if (!currentTrack) return null;
            return (
              <footer className="fixed bottom-0 left-0 right-0 bg-[#181818] border-t border-zinc-800 text-white flex items-center justify-between px-4 z-50" style={{ height: 'calc(6rem + env(safe-area-inset-bottom))', paddingBottom: 'env(safe-area-inset-bottom)' }}>
                <div className="hidden md:flex items-center gap-4 w-1/4">
                  <img src={currentTrack.albumArt} alt={currentTrack.title} className="w-14 h-14 rounded-md" />
                  <div>
                    <p className="font-semibold">{currentTrack.title}</p>
                    <p className="text-sm text-gray-400">{currentTrack.artist}</p>
                  </div>
                </div>
                <div className="flex flex-col items-center justify-center gap-2 flex-grow w-full md:w-auto">
                  <div className="flex items-center gap-4 md:gap-6">
                    <button onClick={onPrev}><Icon name="previous" className="w-6 h-6" /></button>
                    <button onClick={onPlayPause} className="bg-white text-black rounded-full p-3"><Icon name={isPlaying ? 'pause' : 'play'} className="w-6 h-6" /></button>
                    <button onClick={onNext}><Icon name="next" className="w-6 h-6" /></button>
                    <button onClick={onStop}><Icon name="stop" className="w-5 h-5" /></button>
                  </div>
                  <div className="flex items-center gap-2 w-full max-w-lg">
                    <span className="text-xs w-10 text-center">{formatTime(progress.currentTime)}</span>
                    <input type="range" value={progress.currentTime} max={progress.duration || 0} onChange={onSeek} className="w-full h-1 bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-white hover:accent-green-500" />
                    <span className="text-xs w-10 text-center">{formatTime(progress.duration)}</span>
                  </div>
                </div>
                <div className="hidden md:flex items-center justify-end gap-2 w-1/4">
                  <Icon name="volume" className="w-5 h-5 text-gray-400" />
                  <input type="range" min="0" max="1" step="0.01" value={volume} onChange={onVolumeChange} className="w-24 h-1 bg-zinc-600 rounded-lg appearance-none cursor-pointer accent-white" />
                </div>
              </footer>
            );
        };
        
        const App = () => {
          const { useState, useCallback, useRef, useEffect } = React;
          
          const [view, setView] = useState('browser'); // 'browser' | 'album'
          const [selectedAlbumId, setSelectedAlbumId] = useState(null);

          const [currentTrack, setCurrentTrack] = useState(null);
          const [isPlaying, setIsPlaying] = useState(false);
          const [progress, setProgress] = useState({ currentTime: 0, duration: 0 });
          const [volume, setVolume] = useState(1);
          
          const [isPurchaseModalOpen, setIsPurchaseModalOpen] = useState(false);
          const [albumToBuy, setAlbumToBuy] = useState(null);

          const [unlockedAlbums, setUnlockedAlbums] = useState(() => {
              try { return new Set(JSON.parse(localStorage.getItem('unlocked_albums') || '[]')); } catch { return new Set(); }
          });
          const [downloadedTracks, setDownloadedTracks] = useState(() => {
              try { return new Set(JSON.parse(localStorage.getItem('downloaded_tracks') || '[]')); } catch { return new Set(); }
          });
          const [downloading, setDownloading] = useState(new Set());
          const [showOnlyDownloaded, setShowOnlyDownloaded] = useState(false);

          const audioRef = useRef(null);
          
          const saveToLocalStorage = (key, value) => {
              localStorage.setItem(key, JSON.stringify(Array.from(value)));
          };

          const handleUnlockAlbum = useCallback((albumId) => {
              setUnlockedAlbums(prev => {
                  const newSet = new Set(prev).add(albumId);
                  saveToLocalStorage('unlocked_albums', newSet);
                  return newSet;
              });
              setIsPurchaseModalOpen(false);
          }, []);
          
          const handleDownload = useCallback(async (track) => {
              if (downloadedTracks.has(track.id) || downloading.has(track.id) || !track.audioSrc) return;
              setDownloading(prev => new Set(prev).add(track.id));
              try {
                  const cache = await caches.open('rhythmstream-audio-v1');
                  await cache.add(track.audioSrc);
                  setDownloadedTracks(prev => {
                      const newSet = new Set(prev).add(track.id);
                      saveToLocalStorage('downloaded_tracks', newSet);
                      return newSet;
                  });
              } catch (error) {
                  console.error('Failed to download track:', error);
              } finally {
                  setDownloading(prev => {
                      const newSet = new Set(prev);
                      newSet.delete(track.id);
                      return newSet;
                  });
              }
          }, [downloadedTracks, downloading]);

          const handleSelectAlbum = useCallback((albumId, andPlay = false) => {
              setSelectedAlbumId(albumId);
              setView('album');
              if (andPlay) {
                  const album = ALBUMS_DATA.find(a => a.id === albumId);
                  const firstTrack = album?.tracks.find(t => t.available || unlockedAlbums.has(albumId));
                  if (firstTrack) {
                      setCurrentTrack(firstTrack);
                      setIsPlaying(true);
                  }
              }
          }, [unlockedAlbums]);

          const handleTrackSelect = (track) => {
              setCurrentTrack(track);
              setIsPlaying(true);
          };

          const handlePlayPause = () => {
              if (currentTrack) setIsPlaying(p => !p);
          };

          const playNextOrPrevTrack = useCallback((direction) => {
              if (!currentTrack) return;
              const album = ALBUMS_DATA.find(a => a.tracks.some(t => t.id === currentTrack.id));
              if (!album) return;

              const isUnlocked = unlockedAlbums.has(album.id);
              const availableTracks = album.tracks.filter(t => t.available || isUnlocked);
              if (availableTracks.length === 0) return;
              
              const currentIndex = availableTracks.findIndex(t => t.id === currentTrack.id);
              const nextIndex = (currentIndex + (direction === 'next' ? 1 : -1) + availableTracks.length) % availableTracks.length;
              setCurrentTrack(availableTracks[nextIndex]);
              setIsPlaying(true);
          }, [currentTrack, unlockedAlbums]);
          
          const handleNext = useCallback(() => playNextOrPrevTrack('next'), [playNextOrPrevTrack]);
          const handlePrev = useCallback(() => playNextOrPrevTrack('prev'), [playNextOrPrevTrack]);
          
          const handleStop = useCallback(() => {
              setIsPlaying(false);
              setCurrentTrack(null);
          }, []);

          useEffect(() => {
            const audio = audioRef.current;
            if (audio) {
              audio.src = currentTrack?.audioSrc || '';
              if (isPlaying && currentTrack) {
                  audio.play().catch(e => console.error("Error playing audio:", e));
              } else {
                  audio.pause();
              }
            }
          }, [currentTrack, isPlaying]);

          useEffect(() => {
            const audio = audioRef.current;
            const onTimeUpdate = () => setProgress({ currentTime: audio.currentTime, duration: audio.duration || 0 });
            const onEnded = () => handleNext();
            audio.addEventListener('timeupdate', onTimeUpdate);
            audio.addEventListener('loadedmetadata', onTimeUpdate);
            audio.addEventListener('ended', onEnded);
            return () => {
              audio.removeEventListener('timeupdate', onTimeUpdate);
              audio.removeEventListener('loadedmetadata', onTimeUpdate);
              audio.removeEventListener('ended', onEnded);
            };
          }, [handleNext]);
          
          const onSeek = (e) => audioRef.current.currentTime = Number(e.target.value);
          const onVolumeChange = (e) => {
              const newVolume = Number(e.target.value);
              setVolume(newVolume);
              audioRef.current.volume = newVolume;
          };

          const selectedAlbum = ALBUMS_DATA.find(a => a.id === selectedAlbumId);

          return (
            <div className="bg-[#121212] text-gray-300 font-sans min-h-dvh flex flex-col">
              <style>{`
                  .thin-scrollbar::-webkit-scrollbar { width: 8px; }
                  .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
                  .thin-scrollbar::-webkit-scrollbar-thumb { background-color: #52525b; border-radius: 4px; }
                  .toggle-checkbox:checked { right: 0; border-color: #4ade80; }
                  .toggle-checkbox:checked + .toggle-label { background-color: #4ade80; }
              `}</style>

              <div className={`flex-1 flex flex-col ${currentTrack ? 'pb-24' : ''}`}>
                  {view === 'browser' && <Header />}
                  {view === 'browser' ? (
                      <AlbumBrowser onSelectAlbum={handleSelectAlbum} onBuyAlbum={(album) => { setAlbumToBuy(album); setIsPurchaseModalOpen(true); }} />
                  ) : selectedAlbum ? (
                      <AlbumView
                          album={selectedAlbum}
                          onBack={() => setView('browser')}
                          onBuyAlbum={(album) => { setAlbumToBuy(album); setIsPurchaseModalOpen(true); }}
                          currentTrackId={currentTrack?.id}
                          isPlaying={isPlaying}
                          onTrackSelect={handleTrackSelect}
                          unlockedAlbums={unlockedAlbums}
                          downloadedTracks={downloadedTracks}
                          downloading={downloading}
                          onDownload={handleDownload}
                          showOnlyDownloaded={showOnlyDownloaded}
                          setShowOnlyDownloaded={setShowOnlyDownloaded}
                      />
                  ) : null}
              </div>
              
              <audio ref={audioRef} preload="metadata" />

              <Player
                currentTrack={currentTrack}
                isPlaying={isPlaying}
                onPlayPause={handlePlayPause}
                onNext={handleNext}
                onPrev={handlePrev}
                onStop={handleStop}
                progress={progress}
                onSeek={onSeek}
                volume={volume}
                onVolumeChange={onVolumeChange}
              />

              <PurchaseModal
                isOpen={isPurchaseModalOpen}
                onClose={() => setIsPurchaseModalOpen(false)}
                album={albumToBuy}
                onUnlock={handleUnlockAlbum}
              />
            </div>
          );
        };
        
        // --- RENDER ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    </script>
</body>
</html>
